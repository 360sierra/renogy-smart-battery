let $bc = document.getElementById('battery-connect');
let $msg = document.getElementById('msgalert');
let rawDataElement = document.getElementById('rawDataDisplay');

$bc.onclick = (e) => {
    e.preventDefault();

    (async function() {
        try {
            let device;
            if (navigator.userAgent.toLowerCase().includes('bluefy')) {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0xFFD0] }]
                });
            } else {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0xFFD0] }],
                    optionalServices: [0xFFF0]
                });
            }
            let server = await device.gatt.connect();

            let rxService = await server.getPrimaryService(0xFFD0);
            let rxCharacteristic = await rxService.getCharacteristic(0xFFD1);

            let txService = await server.getPrimaryService(0xFFF0);
            let txCharacteristic = await txService.getCharacteristic(0xFFF1);
            await txCharacteristic.startNotifications();

            let requestType = '';
            txCharacteristic.addEventListener('characteristicvaluechanged', (event) => {
                try {
                    const packet = event.target.value;
                    const payload = new DataView(packet.buffer, 3);
                    const rawData = new Uint8Array(packet.buffer);

                    // Display raw data in the textarea
                    rawDataElement.value = Array.from(rawData).map(byte => byte.toString(16).padStart(2, '0')).join(' ');

                    if (requestType === 'getTemps') {
                        // Logic for 'getTemps'
                    } else if (requestType === 'getLevels') {
                        // Logic for 'getLevels'
                    } else if (requestType === 'getCellVolts') {
                        // Logic for 'getCellVolts'
                    }
                } catch (error) {
                    console.error(error);
                }

                requestType = '';
            });
        } catch (err) {
            console.error(err);
            $msg.style.display = 'block';
            $msg.innerHTML = err;
        }
    })();
};
